---
import BaseLayout from "@layouts/BaseLayout.astro";
import SectionHeading from "@components/ui/SectionHeading.astro";
import Button from "@components/ui/Button.astro";
---

<BaseLayout
  title="お問い合わせ"
  description="テキストパントリーへのお仕事のご依頼・ご相談はこちらから。シナリオ制作、ノベライズ、企画段階からのご相談など、お気軽にお問い合わせください。"
>
  <section class="section-spacing">
    <div class="container-narrow">
      <SectionHeading
        title="お問い合わせ"
        titleEn="Contact"
        subtitle="お仕事のご依頼・ご相談はこちらから"
        align="center"
      />

      <div class="mt-12 max-w-xl mx-auto">
        <form id="contact-form" class="space-y-8">
          <!-- 会社名 -->
          <div>
            <label for="company" class="block text-sm font-medium mb-2">
              会社名・団体名
            </label>
            <input
              type="text"
              id="company"
              name="company"
              class="w-full px-4 py-3 border border-[var(--color-border)] bg-[var(--color-background)] focus:outline-none focus:border-[var(--color-foreground)] transition-colors"
              placeholder="株式会社○○"
            />
          </div>

          <!-- お名前 -->
          <div>
            <label for="name" class="block text-sm font-medium mb-2">
              お名前 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 border border-[var(--color-border)] bg-[var(--color-background)] focus:outline-none focus:border-[var(--color-foreground)] transition-colors"
              placeholder="山田 太郎"
            />
          </div>

          <!-- メールアドレス -->
          <div>
            <label for="email" class="block text-sm font-medium mb-2">
              メールアドレス <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-[var(--color-border)] bg-[var(--color-background)] focus:outline-none focus:border-[var(--color-foreground)] transition-colors"
              placeholder="example@example.com"
            />
          </div>

          <!-- 電話番号 -->
          <div>
            <label for="phone" class="block text-sm font-medium mb-2">
              電話番号
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 border border-[var(--color-border)] bg-[var(--color-background)] focus:outline-none focus:border-[var(--color-foreground)] transition-colors"
              placeholder="03-1234-5678"
            />
          </div>

          <!-- お問い合わせ種別 -->
          <div>
            <label for="type" class="block text-sm font-medium mb-2">
              お問い合わせ種別 <span class="text-red-500">*</span>
            </label>
            <select
              id="type"
              name="type"
              required
              class="w-full px-4 py-3 border border-[var(--color-border)] bg-[var(--color-background)] focus:outline-none focus:border-[var(--color-foreground)] transition-colors"
            >
              <option value="">選択してください</option>
              <option value="scenario">シナリオ制作のご依頼</option>
              <option value="novel">ノベライズのご依頼</option>
              <option value="consulting">企画・コンサルティング</option>
              <option value="other">その他のお問い合わせ</option>
            </select>
          </div>

          <!-- お問い合わせ内容 -->
          <div>
            <label for="message" class="block text-sm font-medium mb-2">
              お問い合わせ内容 <span class="text-red-500">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              required
              rows="8"
              class="w-full px-4 py-3 border border-[var(--color-border)] bg-[var(--color-background)] focus:outline-none focus:border-[var(--color-foreground)] transition-colors resize-none"
              placeholder="ご依頼内容やご相談事項をご記入ください"
            ></textarea>
          </div>

          <!-- 送信ボタン -->
          <div class="pt-4">
            <button
              type="submit"
              id="submit-btn"
              class="w-full inline-flex items-center justify-center font-medium tracking-wide transition-all duration-300 btn-primary px-8 py-4 text-base"
            >
              送信する
            </button>
          </div>

        </form>

        <!-- 送信完了モーダル -->
        <div id="success-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
          <div class="bg-[var(--color-background)] p-8 max-w-md mx-4 text-center shadow-xl">
            <div class="text-4xl mb-4">✓</div>
            <h3 class="text-xl font-bold mb-4">送信完了</h3>
            <p class="text-[var(--color-muted-foreground)] mb-6">
              お問い合わせを受け付けました。<br>
              3営業日以内にご返信いたします。
            </p>
            <button
              id="close-modal"
              class="inline-flex items-center justify-center font-medium tracking-wide transition-all duration-300 btn-primary px-6 py-3"
            >
              閉じる
            </button>
          </div>
        </div>

        <!-- エラーモーダル -->
        <div id="error-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
          <div class="bg-[var(--color-background)] p-8 max-w-md mx-4 text-center shadow-xl">
            <div class="text-4xl mb-4 text-red-500">✕</div>
            <h3 class="text-xl font-bold mb-4">送信失敗</h3>
            <p id="error-message" class="text-[var(--color-muted-foreground)] mb-6">
              送信に失敗しました。時間をおいて再度お試しください。
            </p>
            <button
              id="close-error-modal"
              class="inline-flex items-center justify-center font-medium tracking-wide transition-all duration-300 btn-primary px-6 py-3"
            >
              閉じる
            </button>
          </div>
        </div>

        <!-- 注意事項 -->
        <div class="mt-12 p-6 bg-[var(--color-muted)] text-sm text-[var(--color-muted-foreground)]">
          <h3 class="font-medium text-[var(--color-foreground)] mb-3">ご注意事項</h3>
          <ul class="space-y-2 list-disc list-inside">
            <li>通常、3営業日以内にご返信いたします。</li>
            <li>お急ぎの場合はその旨をお問い合わせ内容にご記載ください。</li>
            <li>内容によってはお返事できない場合がございます。</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
  <!-- reCAPTCHA v3 スクリプト -->
  <script is:inline src="https://www.google.com/recaptcha/api.js?render=6LdK5LoqAAAAAB41SZ87bucgwOXSfT4FOL7I1Res"></script>

  <!-- フォーム送信処理 -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('contact-form');
      const submitBtn = document.getElementById('submit-btn');
      const successModal = document.getElementById('success-modal');
      const errorModal = document.getElementById('error-modal');
      const errorMessage = document.getElementById('error-message');
      const closeModalBtn = document.getElementById('close-modal');
      const closeErrorModalBtn = document.getElementById('close-error-modal');

      // モーダルを表示
      function showModal(modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }

      // モーダルを閉じる
      function hideModal(modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
      }

      // 閉じるボタン
      closeModalBtn.addEventListener('click', function() {
        hideModal(successModal);
      });
      closeErrorModalBtn.addEventListener('click', function() {
        hideModal(errorModal);
      });

      // 背景クリックで閉じる
      successModal.addEventListener('click', function(e) {
        if (e.target === successModal) hideModal(successModal);
      });
      errorModal.addEventListener('click', function(e) {
        if (e.target === errorModal) hideModal(errorModal);
      });

      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // ボタンを無効化
        submitBtn.disabled = true;
        submitBtn.textContent = '送信中...';

        try {
          // reCAPTCHA v3 トークン取得
          const token = await grecaptcha.execute('6LdK5LoqAAAAAB41SZ87bucgwOXSfT4FOL7I1Res', { action: 'contact' });

          const formData = new FormData(form);
          formData.append('g-recaptcha-response', token);

          const response = await fetch('/api/contact.php', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            form.reset();
            showModal(successModal);
          } else {
            errorMessage.textContent = result.message || '送信に失敗しました。時間をおいて再度お試しください。';
            showModal(errorModal);
          }
        } catch (error) {
          errorMessage.textContent = '送信に失敗しました。時間をおいて再度お試しください。';
          showModal(errorModal);
        }

        submitBtn.disabled = false;
        submitBtn.textContent = '送信する';
      });
    });
  </script>
</BaseLayout>
