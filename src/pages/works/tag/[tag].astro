---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import SectionHeading from "@components/ui/SectionHeading.astro";
import WorkCard from "@components/ui/WorkCard.astro";
import YearNav from "@components/ui/YearNav.astro";
import TagFilter from "@components/ui/TagFilter.astro";
import { getAllTags } from "@lib/tags";

export async function getStaticPaths() {
  const works = await getCollection("works");
  const tagSet = new Set<string>();

  works.forEach((work) => {
    work.data.tags?.forEach((tag) => {
      if (tag.trim()) {
        tagSet.add(tag);
      }
    });
  });

  return Array.from(tagSet).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;
const allTags = await getAllTags();

// タグに該当する作品を取得
const allWorks = await getCollection("works");
const filteredWorks = allWorks
  .filter((work) => work.data.tags?.includes(tag))
  .sort((a, b) => b.data.year - a.data.year || a.data.order - b.data.order);

// 年でグループ化
const worksByYear = filteredWorks.reduce(
  (acc, work) => {
    const year = work.data.year;
    if (!acc[year]) acc[year] = [];
    acc[year].push(work);
    return acc;
  },
  {} as Record<number, typeof filteredWorks>
);

const years = Object.keys(worksByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<BaseLayout
  title={`${tag}の作品一覧`}
  description={`「${tag}」タグが付いた作品一覧です。`}
>
  <section class="section-spacing">
    <div class="container-content">
      <SectionHeading
        title={`${tag}の作品`}
        titleEn="Works"
        subtitle={`「${tag}」タグが付いた作品 ${filteredWorks.length}件`}
        align="center"
      />

      <!-- タグフィルター -->
      <TagFilter tags={allTags} currentTag={tag} />

      <!-- 作品グリッド（年別） -->
      <div class="relative mt-16 lg:flex lg:gap-12">
        <!-- メインコンテンツ -->
        <div class="flex-1 space-y-20">
          {
            years.map((year) => (
              <div id={`year-${year}`} data-year={year}>
                <div class="flex items-center gap-4 mb-8">
                  <span class="font-display text-4xl text-[var(--color-border)]">
                    {year}
                  </span>
                  <div class="flex-1 h-px bg-[var(--color-border)]" />
                </div>

                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-12">
                  {worksByYear[year].map((work) => (
                    <WorkCard
                      slug={work.id}
                      title={work.data.title}
                      category={work.data.category}
                      year={work.data.year}
                      thumbnail={work.data.thumbnail}
                      description={work.data.description}
                      client={work.data.client}
                      tags={work.data.tags}
                    />
                  ))}
                </div>
              </div>
            ))
          }
        </div>

        <!-- 年ナビゲーション -->
        <YearNav years={years} />
      </div>
    </div>
  </section>
</BaseLayout>
